// Code generated by typed. DO NOT EDIT
package {{- if .GenerateLib }}{{ .LibPkg }}{{- else }}main{{- end}}

import (
    "github.com/d1vbyz3r0/typed"
    "github.com/d1vbyz3r0/typed/handlers"
    "github.com/getkin/kin-openapi/openapi3"
    "github.com/getkin/kin-openapi/openapi3gen"
    "github.com/labstack/echo/v4"
    "reflect"
{{- range .Imports}}
    {{.}}
{{- end}}
)

const (
{{- if ne .ApiPrefix nil }}
    apiPrefix = "{{ .ApiPrefix }}"
    useTags   = true
{{- else }}
    apiPrefix = ""
    useTags   = false
{{- end }}
)

var usedTypes = map[string]any{
    {{- range .Types}}
    "{{.}}": new({{.}}),
    {{- end}}
}

var enums = map[string][]any{
    {{- range $type, $values := .Enums }}
    "{{$type}}": {
        {{- range $i, $val := $values }}
        {{ printf "%#v" $val }},
        {{- end }},
    },
    {{- end }}
}

var spec = &openapi3.T{
    OpenAPI: "3.0.0",
    Info: &openapi3.Info{
        Title:   "{{ .Title }}",
        Version: "{{ .Version }}",
    },
    Servers: []*openapi3.Server{
        {
            URL: "{{ .ServerUrl }}",
        },
    },
    Components: &openapi3.Components{
        Schemas:         make(openapi3.Schemas),
        SecuritySchemes: make(openapi3.SecuritySchemes),
    },
}

var routes []echo.Route

func onRouteAdded(
        host string,
        route echo.Route,
        handler echo.HandlerFunc,
        middleware []echo.MiddlewareFunc,
) {
    routes = append(routes, route)
    for _, mw := range middleware {
        {{/*if typed.IsJwtMiddleware(mw) {*/}}
        {{/*    addJwtAuthSchema()*/}}
        {{/*    protectedRoutes[route.Path] = struct{}{}*/}}
        {{/*}*/}}
    }
}

func Generate() {
    g := openapi3gen.NewGenerator(
        openapi3gen.UseAllExportedFields(),
        openapi3gen.CreateComponentSchemas(openapi3gen.ExportComponentSchemasOptions{
            ExportComponentSchemas: true,
            ExportTopLevelSchema:   true,
            ExportGenerics:         false,
        }),
        openapi3gen.SchemaCustomizer(typed.Customizer),
        openapi3gen.CreateTypeNameGenerator(func(t reflect.Type) string {
            return t.String()
        }),
    )

    typed.RegisterCustomizer(typed.NewEnumsCustomizer(enums))

    routesProvider := {{ .RoutesProviderCtor }}
	routesProvider.OnRouteAdded(onRouteAdded)
    routesProvider.ProvideRoutes()

    finder, err := handlers.NewFinder()
    if err != nil {
        panic(err)
    }

    err = finder.Find([]handlers.SearchPattern{
        {{- range .HandlersPkgs}}
        {
            Path: "{{ .Path }}",
            Recursive: {{ .Recursive }},
        }
        {{- end}},
    })
    if err != nil {
        panic(err)
    }

    matchedHandlers := finder.Match(routes)
    for _, handler := range matchedHandlers {
        operation := openapi3.NewOperation()
        operation.Description = handler.Description()
        typed.AddPathParams(operation, handler, g, usedTypes)
        typed.AddQueryParams(operation, handler, g, usedTypes)
        typed.AddRequestBody(operation, handler, g, spec.Components.Schemas, usedTypes)
        typed.AddOperationId(operation, handler)
        if useTags {
            typed.TagOperation(operation, handler.Path(), apiPrefix)
        }
    }
}

{{- if not .GenerateLib }}
func main() {
    Generate()
}
{{- end }}